-- [[ CONFIG ]] --
local webhook_url = "https://discord.com/api/webhooks/1471473387120361573/OJN4BmXmdHbf89_fJ6oV-QRp7j0XVeQVR4mxYR_aIIZTwmaoHYxU9oYqsGK8OQRecxY4"
local startTime = os.time()
local count = {ruby = 0, evo = 0, mythic = 0, secret = 0}

local list_ruby = {"Gemstone Ruby"}
local list_evo = {"Evolved Enchant Stone"}
local list_mythic = {
    "Bioluminescent Manta Ray", "Abyr Squid", "Armor Catfish", "Blob Fish", "Sea Crustacean", "Runic Sea Crustacean", "Ancient Squid", "Runic Squid", "Cavern Dweller", "Primordial Octopus", "Flatheaded Whale Shark", "Heart Dolphin", "Rose Swordfish", "Rose Bouquet", "Choco Shark",
    "Dotted Stingray", "Loggerhead Turtle", "Prismy Seahorse", "Starlight Manta Ray", "Blueflame Ray", "Magma Shark", "Magma Sunfish", "Blue Flame Ray", "Luminous Fish", "Abyss Seahorse", "Thresher Shark", "Strippled Seahorse", "Fossilized Shark", "Crocodile", "Runebound Crocodile", "Runic Abyssal Shark", "Solarflare Koi", "Komodo Dragon", "Pirate Sailfish"
}
local list_secret = {
    "Cursed Kraken", "Elpirate Gran Maja", "Queen Crab", "King Crab", "Gladiator Shark", "Ancient Lochness Monster", "Elshark Gran Maja", "Broken Heart Nessie", "Love Nessie",
    "Orca", "Crystal Crab", "Lochness Monster", "Lava Well", "Ancient Magmaware", "Eerie Shark", "Monster Shark", "Tin Armor Shark", "Scare", "Great Whale", "Frostborn Shark", "Robot Kraken", "Giant Squid", "Cryoshade Glider", "Frost Born Shark", "King Jelly", "Talon Serpent", "Mosasaur Shark", "Rainbow Comet Shark", "Pirate Megalodon", "Maze Treasure", "Thin Armor Shark", "Worm Fish", "Megalodon", "Blob Shark", "Ancient Lochness", "Zombie Shark", "Zombie Megalodon", "Dead Zombie Shark", "Ghost Shark", "Skeleton Narwhal", "Ghost Worm Fish", "1x1x1x1 Comet Shark", "Bloodmoon Whale", "Armored Shark", "Panther Eel", "Depthseeker Ray", "Bone Whale", "Ancient Whale", "Hacker Shark", "ElRetro Gran Maja", "Strawberry Choc Megalodon", "Krampus Shark", "Emerald Winter Whale", "Winter Frost Shark", "Icebreaker Whale"
}

-- [[ FUNGSI KIRIM WEBHOOK ]] --
local function sendWebhook(fishName, fullText, category, isStart)
    local req = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
    if not req then return end

    local content, description, color
    
    if isStart then
        content = "✅ **Webhook Fishit Aktif!**"
        description = "Script running di akun: **" .. game.Players.LocalPlayer.Name .. "**\nMenunggu kabar dari server..."
        color = 65535 
    else
        count[category] = count[category] + 1
        local s = os.time() - startTime
        local runtime = string.format("%02d:%02d:%02d", math.floor(s/3600), math.floor((s%3600)/60), s%60)
        
        -- LOGIKA AMBIL NAMA PLAYER DARI CHAT SERVER
        local cleanerText = fullText:gsub("<[^>]*>", "") 
        local luckyPlayer = cleanerText:match("%[Server%]%: (.-) obtained") or "Unknown Player"
        
        -- PENENTUAN KATEGORI UNTUK PESAN DISCORD (Mythic/Secret/Stone)
        local displayCategory = "Mythic"
        if category == "secret" then displayCategory = "Secret" end
        if category == "ruby" or category == "evo" then displayCategory = "Stone" end
        
        content = "Congratulations!! **" .. luckyPlayer .. "** You have obtained a new **" .. displayCategory .. "** fish!"
        description = "Berhasil Menangkap: **" .. cleanerText .. "**\n\n**Script Runtime:** " .. runtime .. "\n| Ruby: " .. count.ruby .. " |  Evo: " .. count.evo .. " |  Mythic: " .. count.mythic .. " |  Secret: " .. count.secret
        color = (category == "secret" and 65280) or 16711680
    end

    req({
        Url = webhook_url,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = game:GetService("HttpService"):JSONEncode({
            ["content"] = content,
            ["embeds"] = {{
                ["description"] = description,
                ["color"] = color,
                ["footer"] = {["text"] = "Server Mybubub • " .. os.date("%X")}
            }}
        })
    })
end

-- [[ STARTUP ]] --
sendWebhook(nil, nil, nil, true)

-- [[ DETEKSI CHAT (INSANE SPEED) ]] --
game:GetService("TextChatService").OnIncomingMessage = function(message)
    local txt = message.Text:lower()
    
    -- Hanya proses pesan yang mengandung "[Server]:" dan "obtained"
    if txt:find("%[server%]:") and txt:find("obtained") then
        for _, n in pairs(list_ruby) do if txt:find(n:lower()) then sendWebhook(n, message.Text, "ruby", false) return end end
        for _, n in pairs(list_evo) do if txt:find(n:lower()) then sendWebhook(n, message.Text, "evo", false) return end end
        for _, n in pairs(list_mythic) do if txt:find(n:lower()) then sendWebhook(n, message.Text, "mythic", false) return end end
        for _, n in pairs(list_secret) do if txt:find(n:lower()) then sendWebhook(n, message.Text, "secret", false) return end end
    end
end
